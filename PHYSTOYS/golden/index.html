<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>Fermi_golden rule Canvas Version 3 - September 03, 2010. L. Kocbach, Bergen</title>
 <style type="text/css"><!--
      #container { position: relative; }
      #DRAW_AREA { border: 1px solid #000; }
    --></style>
<!-- The tricks are invented by ROBO Design
 * http://www.robodesign.ro   -->       
<script language="JavaScript">

//             The mouse response has been re-written
//             It is now prepared for touch-screen changes

//   tmaxT   TMAXdiv
</script>
</head>
<!--  
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
          Here starts the HTML -arrangement 
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-->

<body bgcolor = "#FFBBCC">
<div id="Entry_PAD" style="font-family: Helvetica,Arial,sans-serif;"> 
<small>
<b>Fermi_golden rule Canvas Version September 03, 2010</b>
&nbsp; &nbsp; &nbsp;
<span style="background-color: rgb(255, 255, 55);">
This is not working in Microsoft's Internet Exploader.
</span>     <br>

L. Kocbach, Bergen. <b>Here is <a href="http://web.ift.uib.no/~ladi/Fysisk/Teori/Pictures/Golden.html">
http://web.ift.uib.no/~ladi/Fysisk/Teori/Pictures/Golden.html</a> a 1996 explanation of the model</b>
</small>
<br>
</div>



 <table width="850">   <!--  The first line of controls  -->
 <tr>
 <td style="font-family: Helvetica,Arial,sans-serif;">
 <small> 
  <b>Fermi golden rule  </b>   
     <b>Examples:</b>&nbsp; 
    <a href="javascript:example(20)"> N=20 </a>&nbsp;
        <a href="javascript:example(6)"> N=6 </a>&nbsp;
        <a href="javascript:example(4)"> N=4 </a>&nbsp;

        <a href="javascript:example(2)"> N=2 </a>&nbsp;
        <a href="javascript:example(40)">( N=40 )</a>&nbsp;
&nbsp; &nbsp; &nbsp;
 </small>   
 </td>



<td> 
<div id="Basic_PAD" style="font-family: Helvetica,Arial,sans-serif;">
</div>  
</td>


</tr>
</table>
 


<!--   rgb(203,203, 51);  -->

<div id="interrupt_PAD" style="font-family: Helvetica,Arial,sans-serif;">
</div>
<div id="interrupt_PAD2" style="font-family: Helvetica,Arial,sans-serif;">
</div>

                
                                                

<!--      TABLE IMPORTED FROM SCHROEDINGER     --> 






<div id="container"   style="position: relative;">
<!--   ---------------------------------------------------------------------------  -->
<table>                          <!--    THE HTML IS ARRANGED IN A TABLE   -->

<!--   ---------------------------------------------------------------------------  -->
<tr>
<td  valign="top" style="font-family: Helvetica,Arial,sans-serif;">

<small>
<form name="myInputWindow">
Change<br>
and<br>
<a href="javascript:start_calculation()"> RESTART </a>
<br>
<hr>
Number of<br>
 states. <br>
<textarea style=""  name="N_of_states" cols="3" rows="1">
40
</textarea><br>
<hr>
Tmax<br>
<textarea style=""  name="T_MAX_win" cols="7" rows="1">
50.0001
</textarea><br>
<hr>
dT step<br>
<textarea style=""  name="dT_win" cols="7" rows="1">
0.15
</textarea><br>

<hr>
V value<br>
<textarea style=""  name="V_win" cols="7" rows="1">
0.035
</textarea>
<div id="V_PAD" style="font-family: Helvetica,Arial,sans-serif;">           <!-- Here we write the real V value -->
</div>
 </form>

</small>


<!-- //   Text Areas   N_of_states   T_MAX_win  dT_win  V_win  -->




  </td>
<td>
<div id="EnergyView" style="font-family: Helvetica,Arial,sans-serif;">   <!--  EnergyView    -->

       <!--    ENERGY VIEW POSITION  --> 
           
</div> 
<!--   -------------------------     THE CANVAS             ------------------  -->

<div id="LAYERS"   style="position: relative;">

<canvas  class="canvas"  id="rubber" style="position: absolute;" 
	 width="750" height="550"></canvas>
    <canvas class="overlay"  id="DRAW_AREA" style="position: relative;" 
    width="750" height="550" border: 3px solid #000"></canvas>
</div>
<!--   <canvas  class="overlay" id="blob"  style="position: relative; left: 0px; top: 0px;" width="900" height="710" 
   border: 3px solid "#000"  onmouseover="DOWN=false;" onmouseout="DOWN=false;" ></canvas>
-->

<!--   ---------------------------------------------------------------------------  -->
<div id="controlPAD" style="font-family: Helvetica,Arial,sans-serif;">
 <table width="790">
 <tr>
 <td><small>    <a href="javascript:go_to_start()"> t = 0 </a>  </small>   </td>

<td>  <small>   <a href="javascript:stop_running()">STOP</a>   </small>   </td>

<td><small>   <a href="javascript:start_running()"> GO </a>   </small>   </td>


<td><small>   <a href="javascript:make_step()"> Single STEP </a>  </small>    </td>


<td> <small>  <a href="javascript:go_to_end()"> t = Tmax </a>   </small>    </td>

<td> 
   <div id="TMAXdiv" style="font-family: Helvetica,Arial,sans-serif; text-align: left;">
   </div>
</div>  
</td>
</tr>
</table>
 

</div>

</td>
<td> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  </td>
<td valign="top" style="font-family: Helvetica,Arial,sans-serif;">
<small>
<!--   ---------------------------------------------------------------------------  -->
            <b>Keyboard control</b>

<!--   ---------------------------------------------------------------------------  -->
<br>
<a href="javascript:stop_running()">
<b>s</b>  single step</a> <br>
<a href="javascript:start_running()">
<b>g</b> Go - start running </a> <br>
<a href="javascript:start_running()">
<b>SPACE BAR </b> also start running </a> <br>



&nbsp; &nbsp; <br>
&nbsp; &nbsp; <br>
<b>Mouse and keyboard</b>   <br>
1.  &nbsp; click in the lower part to set time <br>
&nbsp; &nbsp; click in the upper part to stop<br>

2.  &nbsp; Use links STOP / GO etc <br><br>

press key s - single step <br>
press key g or space-bar to restart <br>

 <br> <br>
 <b>Long calculation can be stopped</b>
 by the interrupt function
 
 </small> 



</td>
</tr>

<tr>
<td> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  </td>
<td valign="top">   
 
<div id="EventView" style="font-family: Helvetica,Arial,sans-serif;">   <!--  EventView    -->
</div>

           
</td>
<td> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  
</td>
</tr>
</table>
</div>
<div id="display_PAD1" style="font-family: Helvetica,Arial,sans-serif;">
</div>





<div id="output_PAD" style="font-family: Helvetica,Arial,sans-serif;">
<listing> 
This performs the numerical calculation <br />  


</listing>
</div>





































<script type="text/javascript">

// -------------------------------------------------------------------------------------
  var TheCanvas;                                     // *** THE VARIABLES, JAVASCRIPT
  var TheRubber; var rubctx;  var ctx;

  var width=750;  var rwidth=635; var height=550;    // *** GENERAL CANVAS PART
// -------------------------------------------------------------------------------------

var  Keyboard_func= true;
var mSTARTED = 0;

var HTML_of_MoreTexts = " ";   //    HTML manipulation - the last div-window's contents

var StopFlagg = false; 
var calculating=1;

var To_text_area="";
var From_Text_Area="";
var Basic_String="";

function init () {                         //  Function init:   Initialization sequence.

   // Find the canvas element.
     TheCanvas = document.getElementById('DRAW_AREA');
   // Get the 2D canvas context.
     ctx = TheCanvas.getContext('2d');
           ctx.lineWidth = 1;
         ctx.fillStyle = '#FFFFFF';   
          ctx.clearRect(0, 0, width, height); 
	//  RUBBER 
	 TheRubber = document.getElementById("rubber");
     rubctx = TheRubber.getContext('2d');
	   rubctx.lineWidth = 2; rubctx.strokeStyle = '#ddf';
	    rubctx.fillStyle = '#FFFFFF';
	    rubctx.fillRect(0, 0, width, height);
		 

  // Attach the mousedown, mousemove and mouseup event listeners.
    TheCanvas.addEventListener('mousedown', fun_mousedown, false);
    TheCanvas.addEventListener('mousemove', fun_mousemove, false);
    TheCanvas.addEventListener('mouseup',   fun_mouseup, false);
    
	Basic_String=
	    "<small>  Probabilities scaled -  <a href=\"javascript:re_scale(1)\">increase (1.2)</a>   &nbsp; "+
        "<a href=\"javascript:re_scale(-1)\">decrease (0.8)</a>     Now &nbsp; ";

	
   // ******************************************************************** 
   document.onkeydown = function(event)           //   init:  KEYBOARD EVENTS  KEYBOARD 
    {
      var keyCode; 
      if(event == null){
        keyCode = window.event.keyCode; }
      else    {
        keyCode = event.keyCode;  }
                Handle_keyboard(keyCode)
    }

// ***********************************************************   
// 
//   CANVAS MOUSE   see above  - TheCanvas.addEventListener('mousedown', fun_mousedown, false);
//   
//     fun_mousedown(ev)  
//     fun_mousemove(ev)
//     fun_mousemove(ev)
//
//     position relative to the canvas element.

function fun_mousedown(ev) 
 {                                                 //   MOUSEDOWN   = PEN_DOWN
  if (ev.layerX || ev.layerX == 0) { // Firefox
          ev.preventDefault();         //   experimental changes for TOUCH  
      ev._x = ev.layerX;
      ev._y = ev.layerY;
    } else if (ev.offsetX || ev.offsetX == 0) { // Opera
          ev.preventDefault();     //   experimental changes for TOUCH  
      ev._x = ev.offsetX;
      ev._y = ev.offsetY;
    }   
               // ctx.beginPath();    // disabled raw pencil function
        ctx.moveTo(ev._x, ev._y);
                XmouseDOWN=ev._x; YmouseDOWN=ev._y;
        mSTARTED = true; BUTTONdown=1;
           Handle_Mouseclick(); //  This is the mouse steering
                   respond_mouse();             //  This is only diagnostics    
 }

function respond_mouse()
{ var a=1;
}
function fun_mousemove(ev) 
  {                                                  //   MOUSEMOVE   = MOVE_TO
  if (ev.layerX || ev.layerX == 0) { // Firefox
          ev.preventDefault();     //   experimental changes for TOUCH  
      ev._x = ev.layerX;
      ev._y = ev.layerY;
    } else if (ev.offsetX || ev.offsetX == 0) { // Opera
          ev.preventDefault();     //   experimental changes for TOUCH  
      ev._x = ev.offsetX;
      ev._y = ev.offsetY;
    }
        if (mSTARTED) {
       // ctx.lineTo(ev._x, ev._y);                      // disabled raw pencil function
       // ctx.stroke();                                  // disabled raw pencil function
                XmouseMOVED=ev._x; YmouseMOVED=ev._y; 
                Handle_Mouseclick();    //  This is the mouse steering
                  respond_mouse();     //  This is only diagnostics
      }

 }         

function fun_mouseup(ev) 
{                                                   //   MOUSEUP   =  PEN_UP
  if (ev.layerX || ev.layerX == 0) { // Firefox
          ev.preventDefault();               //   experimental changes for TOUCH  
      ev._x = ev.layerX;
      ev._y = ev.layerY;
    } else if (ev.offsetX || ev.offsetX == 0) { // Opera
          ev.preventDefault();              //   experimental changes for TOUCH 
      ev._x = ev.offsetX;
      ev._y = ev.offsetY;
    }   
      if (mSTARTED) {
       // thistool.mousemove(ev);
                XmouseUP=ev._x; YmouseUP=ev._y; BUTTONdown=0;
        mSTARTED = false;
                   Handle_Mouseclick(); //  This is the mouse steering
                   respond_mouse();     //  This is only diagnostics
      }
 }
    // ***********************************************************   CANVAS MOUSE PENCIL
    //   function tool_pencil ()  -removed 

        //    These event variables are treated by   Handle_Mouseclick();
        //    XmouseMOVED  YmouseMOVED ;  XmouseDOWN   YmouseDOWN ; XmouseUP  YmouseUP ;  BUTTONdown   


}   //  This is the whole init function               END OF  INIT  FUNCTION          
//////////////////////////////////////////////////////////////////////////////////


// *********************************************************** 
  //  
  // 
  //    GEOMETRY of DRAW_AREA
  //
// *********************************************************** 
  var OriginX=width/2;
  OriginY=height/2;  
  var Xmax=5.0;   var Ymax=5.0;
  var Xmin=-5.0; var Ymin=-5.0;
  var Xdivide=5;  //  will be adjusted below - depends on rwidth
  var Xscale = (Xmax-Xmin)/width;
  Ymax=Xmax* height / width;
  Ymin= - Ymax;
  var Yscale = Xscale;                     //  (Ymax-Ymin)/height;
  //    remove this later Xdivide = (rwidth - OriginX ) * Xscale;
  var Xrescale=1.0;
  
var Plot_Height=3.2; 
var UpperBase=0.1;
var Lower_Base= - UpperBase - Plot_Height;
var Upper_Width=3.0;  
var Lower_Start= 0.1;  var xTime0= -5 + Lower_Start ; var Lower_Width=10 - 2 * Lower_Start;
var xStart1=( - Lower_Start - Upper_Width );  var xStart2= Lower_Start;
  
 
  
  

  var XmouseDOWN=0; var YmouseDOWN=0; var XmouseMOVED=0; var YmouseMOVED=0; 
  var XmouseUP=0; var YmouseUP=0; var BUTTONdown=0;
  var TheKeyboard=0;
  //   math coordinate system counterparts of 
  //  XmouseDOWN   YmouseDOWN ; XmouseMOVED  YmouseMOVED ;  XmouseUP  YmouseUP ;
  // 
  var Xdown=0; var Ydown=0; var Xmoved=0;   var Ymoved=0; var Xup=0; var Yup=0;
  
  XmouseDOWN=0; YmouseDOWN=0;XmouseMOVED=0; YmouseMOVED=0; 
  XmouseUP=0;YmouseUP=0;BUTTONdown=0;  

  //  
  //     x_canv  positions on canvas  
  //     X_math  positions in Mathematical space
  //
  //     X_math=( x_canv - OriginX ) * Xscale;
  //     Y_math=( -y_canv + OriginY ) * Yscale;
  //
  //     X_math / Xscale +  OriginX =  x_canv ;
  //     Y_math / Yscale -  OriginY = -y_canv ;  
  //
  //     x_canv =   X_math / Xscale +  OriginX ;
  //     y_canv = - Y_math / Yscale +  OriginY  ;

  //     Xdivide = (rwidth - OriginX ) * Xscale;
  
/* The tricks are invented by ROBO Design
 * http://www.robodesign.ro   */

var ColorsSaved=[]; 
ColorsSaved[0]='#00a'; ColorsSaved[1]='#f5c';
ColorsSaved[2]='#cc0';  ColorsSaved[3]='#090';
ColorsSaved[4]='#888';  ColorsSaved[5]='#990';
ColorsSaved[6]='#066';  ColorsSaved[7]='#444';
ColorsSaved[8]='#5aa';  ColorsSaved[9]='#aa5';

    var fading=1;  var fade_alpha=0.04;  var fade_counter=0; var fading_text="  Fading is on";
    
var Event_Output=" ";


var T_INTERUPT= "<small> Remaining time (atomic units)  is ";

var T_INTERUPT1="<small><a href=\"javascript:stop_calculate()\">INTERRUPT</a> the calculation <br></small>"

/////////////////////////////////////////

//      HERE IS THE ACTUAL FERMI GOLDEN RULE CODE 

/////////////////////////////////////////



init();     //    AND HERE WE JUST CALL THE init()   function ; after defining geometry etc .....

             var To_Ouput_done="<small>  Calculation finished <br> "+
                "<a href=\"javascript:display_calcul()\"> Click here to view the output</a> </small>";


      var Nstates=10;
          var Ntimes=10;

//    Number of States       
      var Nstates1=40;
	 var To_text_area=" "+Nstates1;
     
	 //   not necessary   myInputWindow.N_of_states.value = To_text_area;
          
      var  y = []; var x=[];    
                        
      var  W = [];    //  Double Real array to store squared amplitudes
          var w_sing=[];  //  single row of W ( for each time)   
          var  V;
          var Sum=[];  var tt= [];  // Single arrays 
          var t;  var dt; var tmax;
          var  k = 0;
          
      var emin=-1.0;
      var emax=1.0;    //  E min and E max
      var rho;   // S   ... State density       
//        var y[];  var e[];  //   Complex array to store         
      var ki=[];   //for (var  j = 2; j <Nstates; j=j+1){  ki[j] = cZero; }
      var y=[];   // for (var  j = 2; j <Nstates; j=j+1){  y[j] = cZero; }
      var e=[];   // for (var  j = 2; j <Nstates; j=j+1){  e[j] = cZero; }
          var En =[];   //  energy without I 


       
      var running = 1; 
      var lscale=1;        
          

//   Table plot definitions

function TABLE( tWidth, linew) {
  return "<table style=\"text-align: left; vertical-align:top; "+
                  " width: " + tWidth +"px;" +
                                  " font-family: Helvetica,Arial,sans-serif;\" border=\""+ linew  +"\" "+
                  " cellpadding=\"0\" cellspacing=\"0\" bgcolor=\"#FFFFFF\">";
}       

function ATABLE(  linew) {
  return "<table style=\"text-align: left; vertical-align:top; "+
                                  " font-family: monospace;\" border=\""+ linew  +"\" "+
                  " cellpadding=\"0\" cellspacing=\"0\" bgcolor=\"#FFFFFF\">";
}                                         
var TABLE_END=  "</table>";


BOXLEFT=  "<td style=\"vertical-align: top; text-align: left;\">";
BOXCENTER="<td style=\"vertical-align: top; text-align: center;\">";
BOXRIGHT= "<td style=\"vertical-align: top; text-align: right;\">";

var C_TXT="";



                  
var LI_BEG=     "<tr>";   
var BOX_BEG  =  "<td  style=\"font-family: monospace; text-align: left; vertical-align:middle; \">" + "<small><small><small>&nbsp;"
var BOX_END  =  "</small></small></small></span></td>";
var LI_END="</tr>";
var  T_OUT="<br><br>  The plot appears here after the calculation <br> Temaining time (atomic units)  ";
var wscaled=0;
var wwidth = 120;
       var                      fscale =  1;
       var                      fscale1 = 1;
var tTIME=1; var LT=1;
var bars=1;   var colored=1;

//  <span style="color: rgb(51, 51, 255); background-color: rgb(255, 255, 102);">

var color_BEG = "<span style=\"background-color: rgb(255, 255, 160);\">";
var color_END ="</span>";

var Tcolor_BEG = "<span style=\"color: rgb(155, 155, 200);\">";
var Tcolor_END = color_END;


var   Minx=0;    var Maxx= x[Ntimes-1];
var   Miny=0;    var Maxy=1.1;

var vertiDim=25;            //      DISPLAY VARIABLES
var horizDim=100;           //      DISPLAY VARIABLES

var displMatr = [];         //      DISPLAY VARIABLES 

var Empty_line=pads("e",horizDim);




var To_Output="<listing> \n <br /> Calculation - probability of 1. state and sum of all other states listed  \n";
        
//    
//     Dynamical solution of the coupled equations
//    
//       i (d/dt) c(n)  =  M(n,n) c(n)
//    
//     where M(n,n) are n by n matrices, c(n) are a n vector
//    
//         ( V  V     V    V     V ... )
//     M = ( V E1+V   V    0     0 ....)
//         ( V  0    E2+V  0     0 ... )
//         ( V  0     0   E3+V   0 ... )
//         ( .  .     .
//    
//     This matrix model GOLDEN RULE assumption  

// /////////////////////////////////////////////////////////////////
//
//    Using our Complex class
//
//   FORTRAN   evaluate    
//       z = V * exp ( i * omega * t ) + i * H ;
           
//   JAVASCRIPT EQUIVALENT  
//       z =  I.times ( omega * t ).EXP().times(V).PLUS (   I.times ( H )   )   ;

//   CAN BE GROUPED BY PARANTHESES 
//       z = ( (  ( I.times ( omega * t ) ).EXP() ).times(V) ).PLUS (   I.times ( H )   )   ;

//   LESS COMPACT VERSION   
//        zm =  CEXP ( I.times ( omega * t ) );
//   z = CSUM ( zm.times(V) ,   I.times ( H )   )   ;
var cZero = new Complex(0,0);
var cOne = new Complex(1,0);
var I  = new Complex(0,1);
      emin=-1.0;
          
      emax=1.0;
      rho = (emax-emin)/Nstates;
//                 'Interaction strenght V '
//  document.write("<br />  cOne.DIVIDE(I ).  ");
        //    document.write("<br /> " +      cOne.DIVIDE(I ).re  + "    "  +        cOne.DIVIDE(I ).im     );
          

    start_calculation();

// calculate();







// //////////////////////////////////////////////////////////////////
//
//       Complex Number Class definition
//
// //////////////////////////////////////////////////////////////////

//   Construction
function Complex(real, imag) 
    {                            //   Some operations are defined in two mays
    this.re = real;         
        this.im = imag;                 
        this.times = function (a) {                           //      times a real constant
             return new Complex (a*this.re, a*this.im); };      
        this.plus = function (c) {                            //      plus a real constant
             return new Complex (this.re + c , this.im );       }       ;                
        this.abs = function () {                              //      absolute value
             return Math.sqrt(this.re*this.re + this.im*this.im);       }       
        this.CC = function () {                               //      C.C. complex conjugate
             return new Complex (this.re, - this.im);   };
        this.INVERT = function () {                           //      evaluate  1 / this.complex
             return new Complex (this.re/this.abs(), - this.im/this.abs() );    }                
        this.EXP = function ()                                //      complex exponential func of this
        { return new Complex( Math.exp( this.re ) * Math.cos (  this.im )  ,
                              Math.exp( this.re ) * Math.sin (  this.im )   );   };                             
        this.PLUS = function (c) {                            //      PLUS  another complex number
             return new Complex (this.re  + c.re, this.im + c.im );     }               ; 
        this.TIMES = function (c) {                           //      TIMES  another complex number
             return new Complex(this.re   * c.re - this.im * c.im, this.re   * c.im + this.im * c.re);   };     
        this.DIVIDE = function (b) {                           //      DIVIDE by  another complex number
             return this.TIMES(b.INVERT()  );   };                                                                                                               
        }       
// Add two complex numbers and return the result.          REDUNDANT; useful for testing and some long formulas
   function CSUM(a, b) {
    return new Complex(a.re  + b.re , a.im + b.im ); };

// Multiply two complex numbers and return the product.    REDUNDANT; useful for testing and some long formulas
   function CPROD(a, b) 
   { return new Complex(a.re  * b.re - a.im * b.im,
                        a.re  * b.im + a.im * b.re);   };
// e ^ ( Complex c )   exponential of complex number       REDUNDANT; useful for testing and some long formulas 
   function CEXP( c ) 
   { return new Complex( Math.exp( c.re ) * Math.cos (  c.im )  ,
                         Math.exp( c.re ) * Math.sin (  c.im )   );   };   

// //////////////////////////////////////////////////////////////////
//
//       Formatted output functions
//
// //////////////////////////////////////////////////////////////////

        function pads(Strng, count)
           {   var blnks="";
               for (var k=0;k<count;k++){blnks=blnks+Strng;}
               return blnks;
           }                            
        function Format_number( num, Length , Decimpl )
            {  var tot=""; var strn=num+" ";    //  add one space
                   if ( num > 0 ) {strn=" " + strn;}  //  make place for sign of negatives
                   var dec=strn.indexOf(".");
                   var leng=strn.length;
                   if (Decimpl > Length-3) { return num +"* "; }
                   if ( dec > Length - 3 ) { return num +"* "; }
                
           if (dec < 0)   //  if integer without dot
                      { 
                                strn = strn.substr(0, leng -1) + "." + pads("0", Decimpl) + " ";
                                leng=strn.length; 
                          }
                   if (dec>0)
                      {    
                             if ( ( leng-dec -1 ) < Decimpl ) 
                                    { strn = strn.substr(0, leng -1) + pads("0", Decimpl + dec - leng +2) ;} 
                             strn=strn.substr(0,dec+Decimpl+1)+" "; leng=strn.length;
                      }
                        if ( leng == Length ) {return strn; }
                        if ( leng < Length ) { return pads(" ", Length-leng) + strn ; }
            }


function example(Nstat)
{
   To_text_area = Nstat;
   myInputWindow.N_of_states.value = To_text_area;
   start_calculation();
}

function start_calculation()
{
      running=0; 

          Clear_Time_Display();  
          tTIME=1;
  //   Text Areas   N_of_states   T_MAX_win  dT_win  V_win   
      V=0.045;  V=0.035;      
          tmax=50.0;  
          dt=0.15 ;         //   Test values - to be changed

          k = 0;
	  From_Text_Area=myInputWindow.N_of_states.value;   Nstates = parseInt(From_Text_Area);
	//  From_Text_Area=document.getElementById("N_of_states").value; Nstates = parseInt(From_Text_Area);
      From_Text_Area=myInputWindow.T_MAX_win.value;     tmax = parseFloat(From_Text_Area);
      From_Text_Area=myInputWindow.dT_win.value;        dt = parseFloat(From_Text_Area);
      From_Text_Area=myInputWindow.V_win.value;         V  = parseFloat(From_Text_Area);	  
          
      emin=-1.0;
      emax=1.0;    //  E min and E max
      rho = (emax-emin)/Nstates;        // S   ... State density  
          
//        var y[];  var e[];  //   Complex array to store         
      ki=[];   for (var  j = 2; j <Nstates; j=j+1){  ki[j] = cZero; }
      y=[];   for (var  j = 2; j <Nstates; j=j+1){  y[j] = cZero; }
      e=[];   for (var  j = 2; j <Nstates; j=j+1){  e[j] = cZero; }
          
          V= V*20.0*rho;
		  document.getElementById("V_PAD").innerHTML= "<big>V used<br>"+ Format_number( V, 9, 5)+ "</big>"; 
          fscale1=1.0;
          fscale =  1.0;
          if (Nstates < 6)  fscale=fscale1;
          fscale= fscale1 + (Nstates /40)* 5* fscale1;
		     
				 
          //   fscale (40 )   =  300
     To_Output="<listing> \n <br /> Calculation - probability of 1. state and sum of all other states listed  \n";   
         C_TXT="";
                
         document.getElementById("output_PAD").innerHTML= To_Output;                              
  
          To_Output = To_Output + "<br>   Nstates is " + Nstates + "<br>";        
          To_Output = To_Output + "<br>   Strength V is " + V + "<br>";   
          T_OUT="";             

                
      calculate();      
         
        
        
         draw_plotting_windows();
                 


}

function  calculate()
{
//
//  Initialization
//        
//          Energy phases   and amplitudes 
      for (var  ii = 2; ii <Nstates+1; ii=ii+1){
        e[ii] = I.times ( -(emin+(ii-1)*rho)  );
                En[ii] =  emin+(ii-1)*rho; 
                y[ii] = cZero;
      }
      y[1] = cOne;
      t = 0;
//
// computational loop
// 
         k = 0;
    calculating=1;
        setTimeout('do_the_step()',1);
    // var My_interval =     setInterval('do_the_step()',10);   
       
        document.getElementById("interrupt_PAD2").innerHTML= T_INTERUPT1;     // interrupting calc.

}                            //    end of the main function routine calculate()

function do_the_step()
   {
   //   call runge(y,Nstates,t,dt,V,e)
        runge();
        k = k + 1;
                W[k]  = [];           //   empty the row 
        Sum[k] = 0;
        for ( klm = 1; klm <Nstates+1; klm=klm+1) {
            dummy= y[klm].abs();   dummy=dummy*dummy;
                    //  W[k][klm]  =  dummy;
                        w_sing[klm]=dummy;
                        W[k] [klm]=dummy;
           if (klm>1) { Sum[k]  =  Sum[k] + dummy;}
        }
        tt[k] = t;  Ntimes=k; tmaxT=Ntimes*dt;
//    for(var kk=1; kk<  Ntimes; kk=kk+1)
        // { document.write("<br /> " + Format_number( tt[kk], 14, 4) + Format_number( W[kk][1], 14, 6) + Format_number( Sum[kk], 14, 6) );}

        //  document.write("<br /> " + Format_number( tt[k], 14, 4) + Format_number( W[k][1], 14, 6) + Format_number( Sum[k], 14, 6) ); 
     To_Output = To_Output + "<br /> " + 
       Format_number( tt[k], 14, 4) + Format_number( W[k][1], 14, 6) + Format_number( Sum[k], 14, 6);

         T_OUT=T_INTERUPT +  pads("&nbsp;",10) +
                          Format_number( (tmax - t), 10, 4 ) +"<br></small>" ;
         document.getElementById("output_PAD").innerHTML= To_Output;            
                                          
                 document.getElementById("interrupt_PAD").innerHTML= T_OUT;                               
                                                                                                                                  
        //  if ( t > tmax ) break;
      if ((t < tmax ) && (calculating==1)) 
             {                  
                 setTimeout('do_the_step()',0);    }
          else 
             {    
                   running=1; 
				          document.getElementById("Entry_PAD").innerHTML= "";
                         document.getElementById("interrupt_PAD").innerHTML= "";
						 document.getElementById("interrupt_PAD2").innerHTML= "";
                         document.getElementById("display_PAD1").innerHTML= "";    
						 document.getElementById("TMAXdiv").innerHTML=
						 "<span style=\"background-color: rgb(220, 220, 130);\">"+
						 "<small>Displayed Tmax is "+  Format_number( tmaxT, 12,2)+ "</small></span>";      
                          To_Output =  "<a href=\"javascript:hide_calcul()\"> hide this view of the output</a> "+"<br>"+
                                       To_Output + "<br /> " + 
                                        "<a href=\"javascript:hide_calcul()\"> hide this view of the output</a> ";
                                                        
           hide_calcul();
		   document.getElementById("Basic_PAD").innerHTML= 
	            	Basic_String + Format_number( fscale,9, 3 )+"</small>";


                   setTimeout("demo()",0 );}
        
   }
function  hide_calcul()    {document.getElementById("output_PAD").innerHTML= To_Ouput_done;}

function display_calcul()   {document.getElementById("output_PAD").innerHTML= To_Output;}



//      subroutine runge(y,mm,t,dt,V,e)         FORTRAN ORIGINAL  

   function runge()
   //              function runge()   - one step in Runge-Kutta iteration
   {
      //
      //   performs runge kutta 4-step iteration
      //   Initially y(t) as input, Output y(t+dt)
      //
    var k1=[];  var k2=[];  var k3=[];  var k4=[];
    var res=[];
     //     subroutine prdkt(ki,y,t,dt,mm,V,e)   ki is the return, y is input 
         //     call prdkt(k1,y,t,dt,mm,V,e)
          prdkt(t, y);
          for (var  ii = 1; ii <Nstates+1; ii=ii+1){
      //    res(i) = y(i)+ k1(i)*0.5
                k1[ii] = ki[ii]; 
                res[ii]= (  y[ii]   ).PLUS  ( k1[ii].times (0.5)     );
      }  //  end ii loop
          
      //  call prdkt(k2,res,t+0.5*dt,dt,mm,V,e)
          prdkt(t+0.5*dt, res );          
      for (var  ii = 1; ii <Nstates+1; ii=ii+1){          
      //   res(i) = y(i)+ k2(i)*0.5
                   k2[ii] = ki[ii];       
                   res[ii]= (  y[ii]    ).PLUS  ( k2[ii].times (0.5)     )
      }  //  end ii loop

      //  call prdkt(k3,res,t+0.5*dt,dt,mm,V,e)
          prdkt(t+0.5*dt, res );          
      for (var  ii = 1; ii <Nstates+1; ii=ii+1){
      //    res(i) = y(i)+ k3(i)
                   k3[ii] = ki[ii];       
                   res[ii]= (  y[ii]    ).PLUS  ( k3[ii]     )          
      }  //  end ii loop

     //
     // This is the completion of the iteration step:
     //
      t = t + dt                                //   this t is upgraded
      //      call prdkt(k4,res,t,dt,mm,V,e)
          prdkt(t, res );         
      for (var  ii = 1; ii <Nstates+1; ii=ii+1){
          
     //     y(i) = y(i) + k1(i)/6 + k2(i)/3 + k3(i)/3 + k4(i)/6
                    //  k4[ii] = ki[ii];          //   can be eliminated later
                    y[ii]  = ( y[ii]  ).PLUS(  k1[ii].times(1/6) );
                    y[ii]  = ( y[ii]  ).PLUS(  k2[ii].times(1/3) );
                        y[ii]  = ( y[ii]  ).PLUS(  k3[ii].times(1/3) );
                        y[ii]  = ( y[ii]  ).PLUS(  ki[ii].times(1/6) );                                         
      }  //  end ii loop

 }    //   End function runge()   - one step in Runge-Kutta iteration


   function prdkt(time, y_in)
   {
    //     subroutine prdkt(ki,y_in,t,dt,mm,V,e)
    //     returns ki = Coup.matrix * y_in - vector * dt
    //
    //       complex arrays  ki(nstat),y(nstat),e(nstat)             
    //       global variables   V,dt,t
    //       e[i]   stands  for  I.times( En[i]  )   exp( e[j]*t ) means the energy factor
    //  
     //    ki(1) = cmplx(0.,0.)             FORTRAN   original
     //    do  j = 2,mm
     //         ki(1) = ki(1) + cmplx(0,-1)*V*exp(-e(j)*t)*y(j)*dt 
     //         ki(j) =         cmplx(0,-1)*V*exp( e(j)*t)*y(1)*dt
         //    end do          
        ki[1] = cZero; ki[0] = cZero;   //  Nstates=20;
        for (var  j = 2; j <Nstates+1; j=j+1){
           //  ki[1] = ( ki[1] ).PLUS ( (I.times(-V*dt ).TIMES ( CEXP ( e[j].times(-time)  ) )).TIMES( y_in[j] ) ) ;
                    var cmid=CEXP ( e[j].times(-time)  );
                        cmid =  I.times(-V*dt ).TIMES ( cmid ); 
            ki[1] = ( ki[1] ).PLUS (     cmid .TIMES( y_in[j] )       ) ;
                                
                 //     ki[j] =                  (I.times(-V*dt ).TIMES ( CEXP ( e[j].times( time)  ) )).TIMES( y_in[1] ) ;  }
                    cmid=CEXP ( e[j].times( time)  );
                        cmid =  I.times(-V*dt ).TIMES ( cmid ); 
            ki[j] =  cmid.TIMES( y_in[1] )  ;                    }
                //  document.write("<br /> Nstates  ki[Math.ceil(Nstates/2)]" + Math.ceil(Nstates/2) + "   "+      ki[Math.ceil(Nstates/2)].re   + "    "  +       ki[Math.ceil(Nstates/2)].im       );
      }

function stop_calculate()
     { calculating=0; }


function make_step()
     { running=0; demo(); }

function stop_running()
     {   running=0;} 
function start_running()
     {   running=1;  setTimeout("demo()",1 ); }         

function go_to_start()
     {   
             Clear_Time_Display();  
                 tTIME=1; LT=1; setTimeout("demo()",0 ); }        

function go_to_end()
     {   tTIME=Ntimes - 2; LT=1; setTimeout("demo()",0 );  }     
         
function Jump_To( xdist )
     {   
             
             Clear_Time_Display();
                 LT=1;  
                 tTIME= Math.floor( (xdist-xTime0)/(Lower_Width)*(Ntimes-1) ) ;
                 tTIME=Math.max ( 1, Math.min(Ntimes,tTIME) );
                 
         //   Mline(xTime0+Lower_Width*tt[i  ]/tmax, Lower_Base+Plot_Height*  W [i][1],
                 
                 if (running==0 ) {setTimeout("demo()",0 ); }
        }         


function demo()            //    PLOTTING FUNCTION LOOP - TIMEOUT FUNCTION
{       


      
       MRectangle(-1,"#FFFFFF", xStart1,  UpperBase, xStart1 + Upper_Width,  UpperBase +  Plot_Height );
       MRectangle(2,"#000", xStart1,  UpperBase, xStart1 + Upper_Width,  UpperBase +  Plot_Height );
      //    //  draw the initial state line  
             Mline( xStart1, UpperBase + Plot_Height/2, xStart1 + (Upper_Width *0.9)*  W[ tTIME ][ 1 ] , UpperBase + Plot_Height/2 ) 
           //  draw the  line for all remaining states 
                      MRectangle(-1,"#FFFFFF", xStart2,  UpperBase, xStart2 + Upper_Width,  UpperBase +  Plot_Height); 
                         MRectangle(2,"#000", xStart2,  UpperBase, xStart2 + Upper_Width,  UpperBase +  Plot_Height); 
          var xEnd=0;
          for (var jj= 2; jj< Nstates+1 ; jj=jj+1 )
           {
                var Eposition= UpperBase + Plot_Height/2 * (1+ En[jj]);
				xEnd=Upper_Width *0.9;
				xEnd=Math.min( xEnd *  W[ tTIME ][ jj ] * fscale , xEnd );
				Mline( xStart2, Eposition , xStart2 + xEnd , Eposition );                 
           } 

    Time_Plot_Step();
        
    tTIME=tTIME+1; 
        if (tTIME>Ntimes-1)
           {    
             tTIME=1;
         Clear_Time_Display();
           }
        
        if (running==1)
          {   
              //  To_Output=  tTIME + "&nbsp;" + Ntimes + "<br> " + To_Output;
                  //   document.getElementById("output_PAD").innerHTML= To_Output;
          setTimeout("demo()",10);      } 
}


  
function Clear_Time_Display()
  {
     //  CLEAR RECTANGLE
     
     MRectangle(-1,"#FFFFFF", xTime0 ,  Lower_Base, xTime0 + Lower_Width , Lower_Base + Plot_Height );      
     MRectangle(2,"#000", xTime0 ,  Lower_Base, xTime0 + Lower_Width , Lower_Base + Plot_Height );      
      
  }                
 
function Time_Plot_Step()            //    PLOTTING FUNCTION LOOP - TIMEOUT FUNCTION
{

            Npoints=tTIME+1;
    //    Add the mechanism to draw either 1 line or a multiline from the start           

            for(var i=LT; i<Npoints; i=i+1)
            {    
                       Mline(xTime0+Lower_Width*tt[i  ]/tmaxT, Lower_Base+Plot_Height*  W [i][1], 
                             xTime0+Lower_Width*tt[i+1]/tmaxT, Lower_Base+Plot_Height*W [i+1][1] );
            }
           LT=tTIME;
     //   Normally just draw the ONE segment  
   
} //   END FUNCTION Time_Plot_Step()




        
function pads(Strng, count)
           {   var blnks="";
               for (var k=0;k<count;k++){blnks=blnks+Strng;}
               return blnks;
           }            

function draw_plotting_windows() 
{
	 MRectangle(-1,"#FFFFFF", xStart1,  UpperBase, xStart1 + Upper_Width,  UpperBase +  Plot_Height );
	 MRectangle(2,"#000", xStart1,  UpperBase, xStart1 + Upper_Width,  UpperBase +  Plot_Height );
	 MRectangle(-1,"#FFFFFF", xStart2,  UpperBase, xStart2 + Upper_Width,  UpperBase +  Plot_Height); 
	 MRectangle(2,"#000", xStart2,  UpperBase, xStart2 + Upper_Width,  UpperBase +  Plot_Height);  
     MRectangle(2,"#000", xStart1,  UpperBase, xStart1 + Upper_Width,  UpperBase +  Plot_Height );
     MRectangle(2,"#000", xStart2,  UpperBase, xStart2 + Upper_Width,  UpperBase +  Plot_Height); 
     MRectangle(2,"#000", xTime0 ,  Lower_Base, xTime0 + Lower_Width , Lower_Base + Plot_Height );
     tTIME=1;

	    rubctx.fillStyle = '#FFFFFF';
	    rubctx.fillRect(0, 0, width, height);
    
      //    //  draw the initial state line  
             Bline( xStart1, UpperBase + Plot_Height/2, xStart1 + (Upper_Width *0.95) , UpperBase + Plot_Height/2 ) 
      
          var xEnd=0;
          for (var jj= 2; jj< Nstates+1 ; jj=jj+1 )
           {
                var Eposition= UpperBase + Plot_Height/2 * (1+ En[jj]);
				xEnd=Upper_Width *0.95;
				Bline( xStart2, Eposition , xStart2 + xEnd , Eposition );                 
           } 



}

function Mline( xs, ys, xe, ye)      //   Line drawing in the Math coordinate system
    {  var xs_canv; var xe_canv;
           var ys_canv; var ye_canv; 
           xs_canv = Math.ceil(   xs / Xscale +  OriginX );
           ys_canv = Math.ceil( - ys / Yscale +  OriginY ); 
           xe_canv = Math.ceil(   xe / Xscale +  OriginX );
           ye_canv = Math.ceil( - ye / Yscale +  OriginY ); 
       // document.write( "<br>");
       // document.write( xs_canv," &nbsp; &nbsp;", 
       // ys_canv, " &nbsp; &nbsp;", xe_canv," &nbsp; &nbsp;", ye_canv);

           ctx.beginPath();     
           ctx.moveTo( xs_canv, ys_canv );
           ctx.lineTo( xe_canv, ye_canv );
           ctx.stroke();                                   
     }

function Bline( xs, ys, xe, ye)      //   Line drawing in the Math coordinate system
    {  var xs_canv; var xe_canv;
           var ys_canv; var ye_canv; 
           xs_canv = Math.ceil(   xs / Xscale +  OriginX );
           ys_canv = Math.ceil( - ys / Yscale +  OriginY ); 
           xe_canv = Math.ceil(   xe / Xscale +  OriginX );
           ye_canv = Math.ceil( - ye / Yscale +  OriginY ); 
       // document.write( "<br>");
       // document.write( xs_canv," &nbsp; &nbsp;", 
       // ys_canv, " &nbsp; &nbsp;", xe_canv," &nbsp; &nbsp;", ye_canv);

           rubctx.beginPath();     
           rubctx.moveTo( xs_canv, ys_canv );
           rubctx.lineTo( xe_canv, ye_canv );
           rubctx.stroke();                                   
     }

// -----------------------------------------------------------------------
//      
function MRectangle(TYPE, COLOR, xs,ys, xe, ye)   //  Fill = 0, Draw = thickness , Clear < 0 
{
 var xs_canv; var xe_canv;
           var ys_canv; var ye_canv; 
           xs_canv = Math.ceil(   xs / Xscale +  OriginX );
           ys_canv = Math.ceil( - ys / Yscale +  OriginY ); 
           xe_canv = Math.ceil(   xe / Xscale +  OriginX );
           ye_canv = Math.ceil( - ye / Yscale +  OriginY ); 
       // document.write( "<br>");
       // document.write( xs_canv," &nbsp; &nbsp;", 
       // ys_canv, " &nbsp; &nbsp;", xe_canv," &nbsp; &nbsp;", ye_canv);
    if (TYPE==0)    //   Fill Rectangle
    {
     ctx.fillStyle = COLOR;                              //   ctx.fillStyle = '#FFFFFF'
     ctx.fillRect(Math.min(xs_canv,xe_canv), Math.min(ys_canv,ye_canv), Math.abs(xe_canv-xs_canv), Math.abs(ye_canv-ys_canv));
    }
    if (TYPE>0)     //   Draw Rectangle
    {
          ctx.strokeStyle = COLOR;
          ctx.lineWidth = TYPE;
          ctx.strokeRect(Math.min(xs_canv,xe_canv), Math.min(ys_canv,ye_canv), Math.abs(xe_canv-xs_canv), Math.abs(ye_canv-ys_canv));
    }
    if (TYPE<0)       //   Clear Rectangle
    {
          ctx.clearRect(Math.min(xs_canv,xe_canv), Math.min(ys_canv,ye_canv), Math.abs(xe_canv-xs_canv), Math.abs(ye_canv-ys_canv));
    }    

}       
      
                                          
// -----------------------------------------------------------------------
// -------------         BEGIN   KEYBOARD RESPONSE FUNCTION   ------------
// -----------------------------------------------------------------------
// -----------------------------------------------------------------------
//
function Handle_keyboard(keyCode)
   {
      Action='none';
          running=0;
      var TESTING=0;
          if ( TESTING ){
          Event_Output=Event_Output + " Last pressed key code is " + keyCode +  "<br>";
          document.getElementById("EventView").innerHTML= Event_Output+ "</small><br>";         }  

    if(Keyboard_func)
        {               
      switch(keyCode)
      {        
          //    KEYBOARD handlings
          //
  /*      case 69:            //  e for  erase 
                  key_e();
          break; 
        case 74:            //  j for  JavaScript solves by derivative matching 
                  key_j();
          break;        
        case 73:            //  i for iterative; but means single En by derivative matching 
                  key_i();
          break;                                  
        case 76:          //    L  for light blue
          key_l();
          break; 
        case 78:          //    N  for normal forward Schroedinger for current En
          key_n();
          break;                  
        case 68:          //    d  for defaults
          key_d();
          break;   
        case 83:          //    s   for save
          key_s();
          break; 
        case 84:          //    t   for total  derivative matching replot
          key_t();
          break; 
                  
        case 87:          //    w   for write parameters
          key_w();
          break;                  
        case 79:          //    o   old browsers
          key_o();
          break;                  
        case 70:          //    f   fading
                  key_f();
          break; 
        case 72:          //    h half erase
          key_h();
          break; 
        case 66:          //    b   for barrier
          key_b();               
          break;                  
        case 82:          //    r   for remove
          key_r();
          break; 
                  
        case 80:           //  p for potential
                  key_p();
          break; 
        case 32:            //  space  for leaving potential adjusts key_g()
                  key_g();
          break; 
        case 71:            //  g  for go
                  key_g();
          break; 
        case 37:            //  <-  zoom out x-axis     
                  cursor_left();          
                  break;
        case 39:            //  ->  zoom in     x-axis
                  cursor_right();         
                  break;
                case 38:            //   ^ up   arrow  zoom in y-axis
                  cursor_up();  
                  break;                
                case 40:            //   v down arrow  zoom out y-axis
                  cursor_down();                        
                  break;                */  


        case 71:            //  g  for go
                  start_running();
          break; 
        case 32:            //  space  for leaving potential adjusts key_g()
                  start_running();
          break;                  
        case 83:          //    s   for save
          make_step();
          break;                  
        default:                
          break;  
      }
        }    //    if(  Keyboard_func )
                   
    }
// -----------------------------------------------------------------------
// -------------            END  KEYBOARD RESPONSE FUNCTION   ------------
// -----------------------------------------------------------------------

// -------------            BEGIN  MOUSE  RESPONSE FUNCTION   ------------
// -----------------------------------------------------------------------
    function Handle_Mouseclick()
          {  
                  //     Y_math=( -y_canv + OriginY ) * Yscale;
                  //     X_math=( x_canv - OriginX ) * Xscale;
          
            Ycalc= ( -YmouseDOWN + OriginY ) * Yscale;
                Xcalc= (  XmouseDOWN - OriginX ) * Xscale;
                
                if ( Ycalc < 0 )
                  {
                    var Xvalue= Math.max(xTime0, Xcalc);
                            Xvalue= Math.min(xTime0+Lower_Width, Xvalue);
                                Jump_To ( Xvalue );
          //   Mline(xTime0+Lower_Width*tt[i  ]/tmax, Lower_Base+Plot_Height*  W [i][1],

                  }
                else
                  {
                         
                                 if (running ==1 ) { running = 0; }

                  }

                }       
        

// -----------------------------------------------------------------------
// -------------            END  MOUSE RESPONSE FUNCTION   ------------
// -----------------------------------------------------------------------
// -----------------------------------------------------------------------               
	
										
	
	function re_scale(fac)
      {   
	     if (fac> 0) { fscale=fscale*1.2;}
		 else { fscale=fscale*0.8;}
		 document.getElementById("Basic_PAD").innerHTML= 
		 Basic_String + Format_number( fscale,9, 3 )+"</small>";
	  }																			
	
																																													                                          
                        
</script>
<br>
<div id="Exit_PAD" style="font-family: Helvetica,Arial,sans-serif;"> 
<small>

<b>Here is <a href="http://web.ift.uib.no/~ladi/Fysisk/Teori/Pictures/Golden.html">
http://web.ift.uib.no/~ladi/Fysisk/Teori/Pictures/Golden.html</a> a 1996 explanation of the model</b><br>
<span style="background-color: rgb(220, 220, 130);">
View the source of the document - the whole script is included ( Canvas Version 2 - August 29, 2010.L. Kocbach, Bergen.) 
</small>
</span>  
</div>
<br>


</body>
</html>
